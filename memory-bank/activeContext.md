# アクティブコンテキスト

## 現在の作業フォーカス

Discord Bot Control Centerのコマンド管理機能とAPI連携フローの改善に取り組んでいます。特に以下の点に焦点を当てています：

1. API連携フローの最適化とバグ修正
2. コマンド作成・編集フローの改善
3. ビジュアルコマンドビルダーの実装
4. インタラクティブプレビュー機能の追加
5. ボット選択UIの改善
6. AIアシスタント機能テンプレートの実装
7. Supabase連携の実装
8. 外部APIキーの設定と管理

## 最近の変更

### 2025/3/16 - Supabase MCPサーバー連携の実装完了

1. **コマンド管理画面のSupabaseデータ連携**
   - `useCommandsMcp`フックを実装し、コマンド管理機能をSupabaseと連携
   - コマンドの取得、作成、更新、削除機能をSupabaseデータベースと連携
   - 型定義を整備し、フロントエンドとバックエンドの型の互換性を確保
   - テンプレートからのコマンド作成機能をSupabaseデータベースと連携

2. **型定義の整備**
   - `CommandWithPrompt`型の定義を追加
   - `PromptInfo`型の定義を追加
   - `CreateCommandRequest`型の定義を追加
   - `UpdateCommandRequest`型の定義を追加
   - 型の互換性を確保し、TypeScriptのエラーを解消

3. **コマンド管理画面の改善**
   - Supabaseから取得したデータを表示するように更新
   - コマンド作成・編集フローをSupabaseデータベースと連携
   - テンプレートからのコマンド作成機能をSupabaseデータベースと連携
   - コマンドの削除機能をSupabaseデータベースと連携

4. **バグ修正と最適化**
   - テンプレートのオプション型変換の問題を修正
   - プロンプト情報の型互換性の問題を修正
   - コマンドウィザードの型定義を更新し、Supabase MCPサーバーとの連携に対応
   - 非同期処理の最適化とエラーハンドリングの改善

### 2025/3/16 - Supabase MCPサーバー設定とデータベース構築

1. **Supabase MCPサーバーの設定**
   - Supabase MCPサーバーを設定し、データベースへの接続を確立
   - 必要な環境変数を設定（SUPABASE_PROJECT_REF, SUPABASE_DB_PASSWORD, DATABASE_URL, SUPABASE_URL, SUPABASE_KEY）
   - MCPサーバーを通じてデータベースの操作が可能に

2. **データベースの構築**
   - データベーステーブルの作成（bots, commands, prompts, api_integrations, templates, command_logs）
   - インデックスの作成によるパフォーマンス最適化
   - Row Level Security（RLS）ポリシーの設定によるセキュリティ強化
   - 更新トリガーの設定（updated_atカラムの自動更新）
   - テストデータの挿入

3. **フロントエンド連携の準備**
   - MCPヘルパー関数の実装（mcp-helpers.ts）
   - Supabase MCPクライアントの実装（supabase-mcp.ts）
   - APIエンドポイントの実装（/api/mcp/use-tool, /api/mcp/access-resource）
   - カスタムフックの実装（useSupabaseMcp.ts）
   - ボット管理画面の更新（Supabaseデータ連携）

4. **Discord Bot設定の環境変数追加**
   - Discord Botのトークンを環境変数に追加（DISCORD_BOT_TOKEN）
   - Discord ClientIDを環境変数に追加（DISCORD_CLIENT_ID）
   - 環境変数を.env.localファイルに保存

5. **複数API連携フローの表示問題を修正**
   - テンプレートからコマンドを作成する際に、API連携フローの情報が正しく表示されない問題を修正
   - レビューステップでAPI連携フローの情報が表示されるように改善
   - API連携パネルでコマンドオブジェクトを受け取り、API連携フローの情報を表示するように修正

6. **環境変数の設定**
   - Supabase接続情報を環境変数に追加
   - OpenAI APIキーを環境変数に追加
   - Perplexity APIキーを環境変数に追加
   - 本番環境での使用に向けた設定を整備

7. **Discord Bot開発フローの整備**
   - Discord Developer Portalでのボット作成手順をドキュメント化
   - 必要な権限とスコープの設定方法を整理
   - ボットのトークン管理と環境変数への設定方法を確立

### 2025/3/15 - AIアシスタント機能テンプレートの実装

1. **AIアシスタント機能テンプレートの追加**
   - 過去ログ分析アシスタントテンプレートを実装
   - AI対話アシスタントテンプレートを実装
   - リンク検索・要約アシスタントテンプレートを実装
   - 音声認識アシスタントテンプレートを実装
   - 各テンプレートに対応するAPI連携フローを定義

2. **テンプレート構造の最適化**
   - `TEMPLATE_CATEGORIES`配列と`COMMAND_TEMPLATES`配列の構造を整理
   - カテゴリ情報とテンプレート情報を明確に分離
   - TypeScriptの型定義に従った適切なデータ構造に修正

3. **コードの最適化とバグ修正**
   - TypeScriptのエラーを修正し、型安全性を向上
   - コンポーネント間の依存関係を整理
   - 不要なコードの削除と重複の排除

### 2025/3/15 - API連携フローの最適化とバグ修正

1. **複数API連携フロー機能の無限ループバグを修正**
   - 状態更新ロジックを最適化し、無限ループを防止
   - コンポーネント間の依存関係を整理し、不要な再レンダリングを防止
   - 深い比較を実装し、実際に変更がある場合のみ状態を更新するように改善

2. **API連携フローのテンプレート機能を改善**
   - テンプレートからAPI連携フローを正しく反映するように修正
   - テンプレートの設定内容を初期値として使用するロジックを改善
   - 複数APIの連携フローをテンプレートから簡単に設定できるように改善

3. **設定内容の表示を最適化**
   - API設定内容を常に表示するように改善し、ユーザーが設定内容を確認しやすく
   - 設定内容のプレビュー表示を追加し、編集モードでなくても設定内容を確認可能に
   - 設定内容の表示方法を改善し、より見やすく整理

4. **コンポーネントの最適化**
   - `api-flow-builder.tsx`の設定内容表示部分を改善
   - `command-wizard.tsx`の状態更新ロジックを最適化
   - `api-flow-step.tsx`の依存関係を最適化
   - `api-integration-panel.tsx`の状態更新ロジックを改善

### 2025/3/14 - コマンド管理機能の大幅改善

1. **ステップバイステップのコマンドウィザード**
   - タブベースのインターフェースから、より直感的なステップバイステップのウィザード形式に変更
   - 進捗状況を視覚的に表示するプログレスインジケーター
   - 各ステップでの入力検証機能
   - API連携をオプション設定の前に配置するフロー変更（ユーザーフィードバックに基づく改善）

2. **ビジュアルコマンドビルダー**
   - コマンドオプションをドラッグ＆ドロップで並べ替え可能
   - オプションタイプごとのアイコン表示
   - リアルタイムのコマンド構文プレビュー
   - 選択したオプションの詳細編集パネル

3. **インタラクティブコマンドプレビュー**
   - Discord風のUIでコマンド実行をシミュレーション
   - コマンドオプションの入力フォーム
   - ボットの応答表示
   - 実際のDiscordでの表示に近い視覚的フィードバック

4. **ボット選択UIの改善**
   - ボットを先に選択してから、そのボット専用のコマンドを表示する方式に変更
   - ボットごとのコマンド数を表示
   - ボット選択画面のカード形式のUIで視認性向上
   - 選択したボットのコマンドのみを表示し、検索フィルターはそのボット内で適用

5. **API連携フローの改善**
   - 基本情報入力時にAPI連携を選択できるように変更
   - API連携に基づいたコマンドオプションの自動提案機能
   - API連携ごとの専用設定パネル
   - API連携の視覚的な選択インターフェース

## アクティブな決定と考慮事項

1. **コマンド作成フロー**
   - ウィザード形式のステップバイステップアプローチを採用
   - 各ステップで必要な情報を明確に示し、ユーザーの混乱を減らす
   - バリデーションを各ステップで行い、エラーをリアルタイムでフィードバック
   - API連携を先に選択することで、後続のステップでの選択肢を最適化

2. **ビジュアルビルダー**
   - 直感的なドラッグ＆ドロップインターフェースでオプションの管理を容易に
   - リアルタイムプレビューでコマンドの構造を視覚化
   - オプションタイプごとのアイコンで視認性を向上

3. **インタラクティブプレビュー**
   - 実際のDiscord環境に近い見た目と操作感
   - コマンド実行のシミュレーションで、ユーザーが最終結果を確認可能
   - オプション入力フォームで、各オプションタイプに適した入力方法を提供

4. **ボット選択UI**
   - ボットを先に選択する方式で、コマンド管理の文脈をより明確に
   - カード形式のUIで視認性と操作性を向上
   - ボットごとのコマンド数を表示して、管理状況を一目で把握可能

5. **API連携フロー**
   - 基本情報入力時にAPI連携を選択することで、ユーザーの意図を早期に把握
   - 選択したAPIに基づいて、適切なオプションやプロンプトを提案
   - API連携の詳細設定を専用ステップで行うことで、設定の複雑さを分離

6. **AIアシスタント機能テンプレート**
   - 事前定義されたテンプレートで、ユーザーが簡単に高度なAI機能を実装可能に
   - 各テンプレートに最適化されたAPI連携フローを提供
   - ユーザーが必要に応じてカスタマイズできる柔軟性を確保
   - 一般的なユースケースをカバーする多様なテンプレートを提供

7. **Supabase連携**
   - データの永続化にSupabaseを使用
   - ユーザー認証とボット・コマンド管理のデータをSupabaseに保存
   - 環境変数を使用してSupabase接続情報を管理
   - MCPサーバーを使用してSupabaseデータベースに接続

8. **API連携の設定管理**
   - 各APIサービスのキーを環境変数で管理
   - セキュリティを考慮した設計
   - 必要なAPIキーのみを使用するように最適化

## 次のステップ

1. **Supabase連携の完成**
   - ✅ ボット管理テーブルの設計と実装
   - ✅ コマンド管理テーブルの設計と実装
   - ✅ API連携設定テーブルの設計と実装
   - ✅ テンプレートテーブルの設計と実装
   - ✅ コマンドログテーブルの設計と実装
   - 🔄 フロントエンドとの連携実装
     - ✅ ボット管理画面の更新
     - ✅ コマンド管理画面の更新
     - ✅ テンプレート管理画面の更新
   - 認証フローの完成

2. **Discord Bot実行エンジンの実装**
   - Discord.jsを使用したボット実行エンジンの実装
   - コマンド定義をDiscord Botに反映する機能
   - API連携フローの実行ロジックの実装
   - エラーハンドリングとログ機能の実装

3. **テンプレートベースのコマンド作成UIの強化**
   - テンプレート選択画面のUI改善
   - テンプレートのプレビュー機能の追加
   - テンプレートのカスタマイズオプションの拡充
   - テンプレートのカテゴリ分類の最適化

4. **AIアシスタント機能テンプレートの拡充**
   - 画像生成・編集アシスタント
   - 多言語翻訳アシスタント
   - データ分析・可視化アシスタント
   - スケジュール管理アシスタント

5. **コマンド実行ログの表示機能**
   - コマンドの実行履歴を表示する機能を追加
   - 成功・失敗のステータスや実行時間などの情報を含める

6. **コマンドのバージョン管理**
   - コマンドの変更履歴を記録・表示する機能
   - 以前のバージョンへのロールバック機能

7. **コマンドのテスト機能**
   - コマンドをDiscordに実際に登録せずにテストできる機能
   - テスト結果のレポート機能
